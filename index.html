<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SmartHub AI v1.0.4</title>
  <style>
    :root {
      --bg-dark: #0b0f19;
      --text-dark: #eef;
      --bg-light: #f3f3f3;
      --text-light: #111;
      --panel-dark: rgba(255,255,255,0.04);
      --panel-light: rgba(0,0,0,0.04);
      --accent: #00d4ff;
    }
    body {
      margin: 0;
      font-family: Inter, system-ui, Arial, sans-serif;
      background: var(--bg-dark);
      color: var(--text-dark);
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }
    body.light {
      background: var(--bg-light);
      color: var(--text-light);
    }

    .app {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 18px;
      padding: 20px;
      box-sizing: border-box;
      height: 100vh;
      align-items: stretch;
    }

    .panel {
      background: linear-gradient(180deg, var(--panel-dark), var(--panel-dark));
      border-radius: 14px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
    }
    body.light .panel {
      background: linear-gradient(180deg, var(--panel-light), var(--panel-light));
    }

    .header {
      text-align: center;
      font-weight: 700;
      font-size: 20px;
      color: var(--accent);
    }

    .chat-window {
      background: var(--panel-dark);
      border-radius: 10px;
      padding: 12px;
      flex: 1;
      overflow: auto;
      min-height: 120px;
    }
    body.light .chat-window {
      background: var(--panel-light);
    }

    .msg {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    .msg .avatar {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      flex: 0 0 54px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }
    .bubble {
      padding: 12px 14px;
      border-radius: 12px;
      max-width: 78%;
      line-height: 1.35;
      background: rgba(255,255,255,0.04);
    }
    .msg.user { justify-content: flex-end; flex-direction: row-reverse; }
    .msg.user .bubble {
      background: var(--accent);
      color: #002;
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .input-row input[type="text"] {
      flex: 1;
      padding: 12px 14px;
      border-radius: 12px;
      border: none;
      background: rgba(0,0,0,0.2);
      color: inherit;
      outline: none;
    }
    .input-row input[type="file"] {
      display: none;
    }

    .icon-btn, .small-btn {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 10px;
    }
    .icon-btn {
      width: 48px;
      height: 48px;
      background: var(--accent);
      color: #002;
      font-weight: bold;
    }
    .small-btn {
      width: 44px;
      height: 44px;
      background: #222;
      color: #ddd;
    }

    .settings {
      background: linear-gradient(180deg, var(--panel-dark), var(--panel-dark));
      border-radius: 14px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    body.light .settings {
      background: linear-gradient(180deg, var(--panel-light), var(--panel-light));
    }

    .settings h3 { margin: 0; color: var(--accent); }
    .field { display: flex; flex-direction: column; gap: 8px; font-size: 14px; }
    .switch-label { margin-bottom: 4px; }

    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 6px;
      font-size: 13px;
      opacity: .85;
    }
    .version { margin-left: auto; }
  </style>
</head>
<body>
  <div class="app">
    <div class="panel">
      <div class="header">SmartHub AI</div>
      <div id="chat" class="chat-window" aria-live="polite" role="log"></div>
      <div class="input-row">
        <input id="userInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" />
        <label for="imageInput" class="small-btn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ">üì∑</label>
        <input id="imageInput" type="file" accept="image/*" />
        <button class="icon-btn" id="sendBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
        <button class="small-btn" id="micBtn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
        <button class="small-btn" id="speakBtn" title="–û–∑–≤—É—á–∏—Ç—å">üîä</button>
      </div>
      <div class="footer">
        <div class="version">SmartHub AI v1.0.5</div>
      </div>
    </div>

    <aside class="settings" id="settingsPanel">
      <h3>‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <div class="field">
        <label><input type="checkbox" id="themeSwitch"> –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</label>
      </div>
      <div class="field">
        <label>–û–∑–≤—É—á–∫–∞:</label>
        <select id="voiceSelect">
          <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
          <option value="male">–ú—É–∂—Å–∫–æ–π</option>
        </select>
      </div>
      <button id="clearBtn" style="padding:12px;background:#ff7b00;border:none;border-radius:10px;color:#001;font-weight:700;cursor:pointer">üóë –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
    </aside>
  </div>

  <script>
    const API_URL = "https://openai-proxy-3.onrender.com/v1/responses";

    let chatHistory = JSON.parse(localStorage.getItem('sh_chatHistory') || '[]');
    let lastAI = "";
    let voicesList = [];
    let selectedVoiceGender = localStorage.getItem('sh_voice_gender') || 'female';

    const chatEl = document.getElementById('chat');
    const fileInput = document.getElementById('imageInput');

    function renderMessage(text, role) {
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + role;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;
      wrap.appendChild(bubble);
      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function saveChatHistory() {
      localStorage.setItem('sh_chatHistory', JSON.stringify(chatHistory));
    }

    function clearChat() {
      if (!confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —á–∞—Ç?")) return;
      chatHistory = [];
      saveChatHistory();
      chatEl.innerHTML = '';
      lastAI = '';
    }

    function speakText(text) {
      if (!text) return;
      const synth = window.speechSynthesis;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ru-RU';

      const pref = document.getElementById('voiceSelect').value;
      let voice = voicesList.find(v => {
        if (pref === 'male') return /male|man/i.test(v.name);
        else return /female|woman/i.test(v.name);
      }) || voicesList[0];

      utter.voice = voice;
      localStorage.setItem('sh_voice_gender', pref);
      synth.cancel();
      synth.speak(utter);
    }

    function startSpeechToText() {
      const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!Rec) { alert("–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"); return; }
      const rec = new Rec();
      rec.lang = 'ru-RU';
      rec.onresult = e => {
        document.getElementById('userInput').value = e.results[0][0].transcript;
      };
      rec.start();
    }

    async function sendMessage(text, base64Image = null) {
      // show that AI is thinking
      renderMessage("...", "ai");
      try {
        const body = { model: "gpt-4o-mini", input: text };
        if (base64Image) {
          body.image = base64Image; // –ø–µ—Ä–µ–¥–∞—ë–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        }
        const resp = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const data = await resp.json();
        let answer = "";
        if (data.choices && data.choices[0]?.message?.content) {
          answer = data.choices[0].message.content;
        } else if (data.output && data.output[0]?.content) {
          const chunks = data.output[0].content;
          const textChunk = chunks.find(c => c.text) || chunks[0];
          answer = textChunk.text || textChunk.content || "";
        } else {
          answer = "–û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞";
        }
        // remove ‚Äú...‚Äù message
        chatHistory.pop();
        chatHistory.push({ role: "ai", text: answer });
        saveChatHistory();
        renderMessage(answer, "ai");
        lastAI = answer;
      } catch (e) {
        chatHistory.pop();
        saveChatHistory();
        renderMessage("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞", "ai");
        console.error(e);
      }
    }

    document.getElementById('sendBtn').addEventListener('click', () => {
      const txt = document.getElementById('userInput').value.trim();
      if (!txt) return;
      chatHistory.push({ role: "user", text: txt });
      saveChatHistory();
      renderMessage(txt, "user");
      sendMessage(txt);
      document.getElementById('userInput').value = "";
    });

    document.getElementById('micBtn').addEventListener('click', startSpeechToText);
    document.getElementById('speakBtn').addEventListener('click', () => speakText(lastAI));
    document.getElementById('clearBtn').addEventListener('click', clearChat);

    // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const base64 = reader.result.split(',')[1];
        // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
        chatHistory.push({ role: "user", text: "[–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]" });
        saveChatHistory();
        renderMessage("[–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]", "user");
        sendMessage("", base64);
      };
      reader.readAsDataURL(file);
    });

    // —Ç–µ–º–∞
    const themeSwitch = document.getElementById('themeSwitch');
    themeSwitch.addEventListener('change', () => {
      const on = themeSwitch.checked;
      document.body.classList.toggle("light", on);
      localStorage.setItem('sh_theme_is_light', on ? '1' : '0');
    });

    (function init(){
      // –∑–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
      loadSavedAndRender();
      // –≤—ã–±–æ—Ä –≥–æ–ª–æ—Å–∞
      voicesList = window.speechSynthesis.getVoices();
      window.speechSynthesis.onvoiceschanged = () => {
        voicesList = window.speechSynthesis.getVoices();
      };
      const vsel = document.getElementById('voiceSelect');
      vsel.value = selectedVoiceGender;
      // —Ç–µ–º–∞
      const saved = localStorage.getItem('sh_theme_is_light') === '1';
      themeSwitch.checked = saved;
      document.body.classList.toggle("light", saved);
    })();

    function loadSavedAndRender(){
      chatHistory.forEach(msg => {
        renderMessage(msg.text, msg.role);
      });
    }

  </script>
</body>
</html>
